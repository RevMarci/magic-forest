<!DOCTYPE html>
<html lang="hu">
    <head>
        <meta charset="utf-8" />
        <title>Three.js Object Tester Skeleton</title>
        <style>
            body {
                margin: 0;
                overflow: hidden;
            }
            canvas {
                width: 100%;
                height: 100%;
            }
        </style>
    </head>

    <body>
        <script async src="./dist/es-module-shims.js"></script>
        <script type="importmap">
            {
                "imports": {
                    "three": "./js-r178/build/three.module.js",
                    "trackballcontrols": "./js-r178/examples/jsm/controls/TrackballControls.js",
                    "BufferGeometryUtils": "./imported/BufferGeometryUtils.js",
                    "tree": "./components/tree.js",
                    "lamp": "./components/lamp.js"
                }
            }
        </script>

        <script type="module">
            import * as THREE from 'three';
            import { TrackballControls } from 'trackballcontrols';
            import { Tree, TreeFactory } from 'tree';

            // Globális változók
            let WIDTH, HEIGHT, aspectRatio;
            let renderer;
            let scene, camera;
            let controls;

            const groundSize = 100;

            init();
            // Egy képkocka rajzolása
            // render();
            // Animáció indítása
            animate();

            function init() {
                // Böngésző ablakméret lekérése és méretarány számítása
                HEIGHT = window.innerHeight;
                WIDTH = window.innerWidth;
                aspectRatio = WIDTH / HEIGHT;

                // Renderer létrehozása és DOM-hoz adása
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(WIDTH, HEIGHT);
                renderer.setClearColor(0x000000);
                renderer.shadowMap.enabled = true;
                document.body.appendChild(renderer.domElement);

                // Színtér létrehozása
                scene = new THREE.Scene();

                // Kamera létrehozása és vetítési paramétereinek beállítása
                camera = new THREE.PerspectiveCamera(75, aspectRatio, 0.1, 1000);
                camera.position.set(0, 10, 20);
                camera.lookAt(scene.position.x, scene.position.y, scene.position.z);

                // Objektumok létrehozása

                //
                scene.add(ground(groundSize));
                const tree = new Tree(0, 0);
                tree.addToScene(scene);

                //const tree2 = new Tree(50, 0);
                //tree2.addToScene(scene);

                const treeFactory = new TreeFactory(groundSize, 30);
                treeFactory.addToScene(scene);

                let boxGeometry = new THREE.BoxGeometry(2, 2, 2);
                let boxMaterial = new THREE.MeshPhongMaterial({
                    color: 0x6b623e,
                    shininess: 20,
                    specular: 0x111111,
                    side: THREE.FrontSide,
                    wireframe: false,
                });
                let boxMesh = new THREE.Mesh(boxGeometry, boxMaterial);
                boxMesh.position.set(6, 1, -5);
                boxMesh.castShadow = true;
                boxMesh.receiveShadow = true;
                scene.add(boxMesh);

                let ambientLight = new THREE.AmbientLight(0x111111, 2);
                scene.add(ambientLight);

                let dLight = new THREE.DirectionalLight(0xffffff, 0.3);
                dLight.position.set(5, 10, 5);
                dLight.target.position.set(0, 0, 0);
                scene.add(dLight);

                let pLight = new THREE.PointLight(0xaaaaff, 1000);
                pLight.position.set(5, 5, 5);
                pLight.castShadow = true;
                scene.add(pLight);

                let sphereSize = 0.2;
                let pointLightHelper = new THREE.PointLightHelper(pLight, sphereSize);
                scene.add(pointLightHelper);

                let sLight = new THREE.SpotLight(0xffaaaa, 1000);
                sLight.position.set(-15, 20, 0);
                sLight.angle = Math.PI / 8;
                sLight.castShadow = true;
                sLight.target.position.set(-10, 5, -5);
                scene.add(sLight);

                let spotLightHelper = new THREE.SpotLightHelper(sLight);
                scene.add(spotLightHelper);
                //

                // Az ablak későbbi átméretezése esetén visszahívható függvény megadása
                window.addEventListener('resize', handleWindowResize, false);

                // Kamera vezérlés
                controls = new TrackballControls(camera, renderer.domElement);
                controls.rotateSpeed = 5.0;
                controls.panSpeed = 1.0;
            }

            function handleWindowResize() {
                // Az ablak átméretezése esetén a kamera vetítési paraméterek újraszámolása
                HEIGHT = window.innerHeight;
                WIDTH = window.innerWidth;
                console.log('WIDTH=' + WIDTH + '; HEIGHT=' + HEIGHT);
                renderer.setSize(WIDTH, HEIGHT);
                aspectRatio = WIDTH / HEIGHT;
                camera.aspect = aspectRatio;
                camera.updateProjectionMatrix();

                render();
            }

            function animate() {
                // Újabb képkocka rajzolásának kérése.
                // Maximálisan 60 FPS-t biztosít a rendszer.
                requestAnimationFrame(animate);
                // Kameramozgás vezérlése
                controls.update();
                // Új képkocka rajzolása
                render();
            }

            function render() {
                // 3D -> 2D vetített kép kiszámítása.
                // scene 3D színtér képe a camera kamera szemszögéből.
                renderer.render(scene, camera);
            }

            function ground(size) {
                let groundGeometry = new THREE.PlaneGeometry(size, size);
                /*let groundMaterial = new THREE.MeshBasicMaterial({
                    color: 0x008000,
                    wireframe: false,
                    side: THREE.DoubleSide,
                });*/

                let groundMaterial = new THREE.MeshPhongMaterial({
                    color: 0x008000,
                    shininess: 20,
                    specular: 0x111111,
                    side: THREE.FrontSide,
                    wireframe: false,
                });
                let groundMesh = new THREE.Mesh(groundGeometry, groundMaterial);
                groundMesh.receiveShadow = true;
                groundMesh.rotation.x = -1.0 * THREE.MathUtils.degToRad(90);
                groundMesh.scale.set(1.2, 1, 1.2);

                return groundMesh;
            }
        </script>
    </body>
</html>
