<!DOCTYPE html>
<html lang="hu">
    <head>
        <meta charset="utf-8" />
        <title>Three.js Object Tester Skeleton</title>
        <style>
            body {
                margin: 0;
                overflow: hidden;
            }
            canvas {
                width: 100%;
                height: 100%;
            }
            #namepanel, #helpPanel {
                position: absolute;
                padding: 15px;
                color: white;
                font-family: 'Arial', sans-serif;
                z-index: 100;
                font-size: 14px;
            }
        
            #namepanel {
                top: 10px;
                left: 10px;
            }
            #helpPanel {
                top: 10px;
                right: 10px;
            }
        </style>
    </head>

    <body>
        <div id="namepanel">
            Név: Révész Márton<br>
            Neptun kód: ALONKX <br>
            Szak: programtervező informatikus BSc <br>
            Tanév: 2024/2025 II. félév.
        </div>
        <div id="helpPanel">
            <p>I - Információk megjelenítése/elrejtése</p>
            <p>Space nyomvatartva - Varázskő animáció/fény fokozatosan fel erősödik</p>
            <p>N - Nap be/ki</p>
            <p>L - Lámpák be/ki</p>
        </div>

        <script async src="./dist/es-module-shims.js"></script>
        <script type="importmap">
            {
                "imports": {
                    "three": "./js-r178/build/three.module.js",
                    "trackballcontrols": "./js-r178/examples/jsm/controls/TrackballControls.js",
                    "BufferGeometryUtils": "./imported/BufferGeometryUtils.js",

                    "tree": "./components/tree.js",
                    "lamp": "./components/lamp.js",
                    "wolf": "./components/wolf.js",
                    "mushroom": "./components/mushroom.js",
                    "mushroomBlend": "./components/blender/gomba.obj",
                    "stone": "./components/stone.js",
                    "sun": "./components/sun.js",

                    "OBJLoader": "./js-r178/examples/jsm/loaders/OBJLoader.js"
                }
            }
        </script>

        <script type="module">
            window.addEventListener('keydown', (event) => {
                if (event.code === 'KeyI') {
                    const namePanel = document.getElementById('namepanel');
                    const helpPanel = document.getElementById('helpPanel');
                    if (namePanel.style.display === 'none') {
                        namePanel.style.display = 'block';
                        helpPanel.style.display = 'block';
                    } else {
                        namePanel.style.display = 'none';
                        helpPanel.style.display = 'none';
                    }
                }
            });


            import * as THREE from 'three';
            import { TrackballControls } from 'trackballcontrols';
            import { Tree, TreeFactory } from 'tree';
            import { Lamp, LampFactory } from 'lamp';
            import { Mushroom, MushroomFactory } from 'mushroom';
            import { Wolf } from 'wolf';
            import { Stone } from 'stone';
            import { Sun } from 'sun';

            // Globális változók
            let WIDTH, HEIGHT, aspectRatio;
            let renderer;
            let scene, camera;
            let controls;

            var stone = null;
            var lampPole = null;
            var lampPole2 = null;
            var lampPole3 = null;
            var wolf = null;
            var wolf2 = null;
            var wolf3 = null;

            const groundSize = 100;


            // LOADER
            const manager = new THREE.LoadingManager();

            manager.onStart = function (url, itemsLoaded, itemsTotal) {
                console.log('Betöltés elkezdődött: ' + url);
            };
            
            manager.onLoad = function () {
                console.log('Minden fájl betöltve!');
            };
            
            manager.onProgress = function (url, itemsLoaded, itemsTotal) {
                console.log(`Betöltve: ${itemsLoaded} / ${itemsTotal}`);
            };
            
            manager.onError = function (url) {
                console.error('Hiba történt: ' + url);
            };
            
            const textureLoader = new THREE.TextureLoader(manager);
            
            const wolfTexture = textureLoader.load('texture/wolf.jpg');
            const grassTexture = textureLoader.load('texture/grass.jpg');
            grassTexture.wrapS = THREE.RepeatWrapping;
            grassTexture.wrapT = THREE.RepeatWrapping;
            grassTexture.repeat.set(100,100);


            init();
            // Egy képkocka rajzolása
            // render();
            // Animáció indítása
            animate();

            function init() {
                // Böngésző ablakméret lekérése és méretarány számítása
                HEIGHT = window.innerHeight;
                WIDTH = window.innerWidth;
                aspectRatio = WIDTH / HEIGHT;

                // Renderer létrehozása és DOM-hoz adása
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(WIDTH, HEIGHT);
                renderer.setClearColor(0x000000);
                renderer.shadowMap.enabled = true;
                document.body.appendChild(renderer.domElement);

                // Színtér létrehozása
                scene = new THREE.Scene();

                // Kamera létrehozása és vetítési paramétereinek beállítása
                camera = new THREE.PerspectiveCamera(75, aspectRatio, 0.1, 1000);
                camera.position.set(0, 10, 20);
                camera.lookAt(scene.position.x, scene.position.y, scene.position.z);

                // Objektumok létrehozása

                //
                scene.add(ground(groundSize));

                // -------------------------------------------------------------- STONE
                stone = new Stone(0,0);
                stone.addToScene(scene);

                // -------------------------------------------------------------- SUN
                const sun = new Sun();
                sun.addToScene(scene);

                // -------------------------------------------------------------- TREE FACTORY
                //const tree2 = new Tree(5, -5);
                //tree2.addToScene(scene);
                const treeFactory = new TreeFactory(groundSize, 15);
                treeFactory.addToScene(scene);

                // -------------------------------------------------------------- LAMP FACTORY
                lampPole = new Lamp(10,10);
                lampPole.addToScene(scene);
                lampPole2 = new Lamp(-30,20);
                lampPole2.addToScene(scene);
                lampPole3 = new Lamp(-34,-20);
                lampPole3.addToScene(scene);
                //const lampPole2 = new Lamp(3,3);
                //lampPole2.addToScene(scene);
                //const lampFactory = new LampFactory(groundSize, 3);
                //lampFactory.addToScene(scene);

                // -------------------------------------------------------------- GOMBA FACTORY
                const mushroomFactory = new MushroomFactory(groundSize, 20);
                mushroomFactory.addToScene(scene);

                // -------------------------------------------------------------- WOLF FACTORY
                wolf = new Wolf(wolfTexture, 3,2,5);
                wolf.addToScene(scene);
                wolf2 = new Wolf(wolfTexture, 0,10,40,0.01,-70);
                wolf2.addToScene(scene);
                wolf3 = new Wolf(wolfTexture, -30,20,10,0.07,180);
                wolf3.addToScene(scene);

                let ambientLight = new THREE.AmbientLight(0xffffff, 0.1);
                scene.add(ambientLight);

                //

                // Az ablak későbbi átméretezése esetén visszahívható függvény megadása
                window.addEventListener('resize', handleWindowResize, false);

                // Kamera vezérlés
                controls = new TrackballControls(camera, renderer.domElement);
                controls.rotateSpeed = 5.0;
                controls.panSpeed = 1.0;
            }

            function handleWindowResize() {
                // Az ablak átméretezése esetén a kamera vetítési paraméterek újraszámolása
                HEIGHT = window.innerHeight;
                WIDTH = window.innerWidth;
                console.log('WIDTH=' + WIDTH + '; HEIGHT=' + HEIGHT);
                renderer.setSize(WIDTH, HEIGHT);
                aspectRatio = WIDTH / HEIGHT;
                camera.aspect = aspectRatio;
                camera.updateProjectionMatrix();

                render();
            }

            function animate() {
                // Újabb képkocka rajzolásának kérése.
                // Maximálisan 60 FPS-t biztosít a rendszer.
                requestAnimationFrame(animate);
                // Kameramozgás vezérlése
                controls.update();

                stone.animate();
                lampPole.animate();
                lampPole2.animate();
                lampPole3.animate();
                wolf.animate();
                wolf2.animate();
                wolf3.animate();

                // Új képkocka rajzolása
                render();
            }

            function render() {
                // 3D -> 2D vetített kép kiszámítása.
                // scene 3D színtér képe a camera kamera szemszögéből.
                renderer.render(scene, camera);
            }

            function ground(size) {
                let groundGeometry = new THREE.PlaneGeometry(size, size);

                let groundMaterial = new THREE.MeshPhongMaterial({
                    map: grassTexture,
                    shininess: 20,
                    specular: 0x111111,
                    side: THREE.FrontSide,
                    wireframe: false
                });
                let groundMesh = new THREE.Mesh(groundGeometry, groundMaterial);
                groundMesh.receiveShadow = true;
                groundMesh.rotation.x = -1.0 * THREE.MathUtils.degToRad(90);
                groundMesh.scale.set(1.2, 1, 1.2);

                return groundMesh;
            }
        </script>
    </body>
</html>
